{% extends "base_generic.html" %}
{% load custom_filters %}

{% block title %}Top Books{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-6 text-indigo-600">Top Books</h1>

<div class="mb-8">
    <div class="flex justify-center mb-4">
        <button class="tab-button bg-indigo-600 text-white px-4 py-2 rounded-tl-lg rounded-tr-lg focus:outline-none" onclick="openTab(event, 'top-rated')">
            <i class="fas fa-star mr-2"></i>Top 10 Rated Books
        </button>
        <button class="tab-button bg-gray-300 text-gray-700 px-4 py-2 rounded-tl-lg rounded-tr-lg focus:outline-none" onclick="openTab(event, 'top-selling')">
            <i class="fas fa-dollar-sign mr-2"></i>Top 50 Selling Books
        </button>
    </div>

    <div id="top-rated" class="tab-content">
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-lg">
                <thead>
                    <tr class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left"><i class="fas fa-book mr-2"></i>Title</th>
                        <th class="py-3 px-6 text-left"><i class="fas fa-user mr-2"></i>Author</th>
                        <th class="py-3 px-6 text-left"><i class="fas fa-star mr-2"></i>Rating</th>
                        <th class="py-3 px-6 text-left"><i class="fas fa-arrow-up mr-2"></i>Highest Rated Review</th>
                        <th class="py-3 px-6 text-left"><i class="fas fa-arrow-down mr-2"></i>Lowest Rated Review</th>
                    </tr>
                </thead>
                <tbody id="topRatedBooks" class="text-gray-700 text-sm font-light">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="top-selling" class="tab-content hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-lg">
                <thead>
                    <tr class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white uppercase text-sm leading-normal">
                        <th class="py-3 px-6 text-left"><i class="fas fa-book mr-2"></i>Title</th>
                        <th class="py-3 px-6 text-left"><i class="fas fa-user mr-2"></i>Author</th>
                        <th class="py-3 px-6 text-left"><i class="fas fa-dollar-sign mr-2"></i>Total Sales</th>
                        <th class="py-3 px-6 text-left"><i class="fas fa-coins mr-2"></i>Total Sales by Author</th>
                        <th class="py-3 px-6 text-left"><i class="fas fa-calendar-alt mr-2"></i>Top 5 of Publication Year</th>
                    </tr>
                </thead>
                <tbody id="topSellingBooks" class="text-gray-700 text-sm font-light">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-center mt-4" id="topSellingPagination">
            <!-- Pagination buttons will be loaded here -->
        </div>
    </div>
</div>

<script>
    function openTab(evt, tabName) {
        var i, tabcontent, tabbuttons;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.add("hidden");
        }
        tabbuttons = document.getElementsByClassName("tab-button");
        for (i = 0; i < tabbuttons.length; i++) {
            tabbuttons[i].classList.remove("bg-indigo-600", "text-white");
            tabbuttons[i].classList.add("bg-gray-300", "text-gray-700");
        }
        document.getElementById(tabName).classList.remove("hidden");
        evt.currentTarget.classList.add("bg-indigo-600", "text-white");
        evt.currentTarget.classList.remove("bg-gray-300", "text-gray-700");

        if (tabName === 'top-rated') {
            fetchTopRatedBooks();
        } else if (tabName === 'top-selling') {
            fetchTopSellingBooks();
        }
    }

    async function fetchTopRatedBooks() {
        const response = await fetch('/top-books/top-rated/');
        const data = await response.json();
        const tbody = document.getElementById('topRatedBooks');
        tbody.innerHTML = '';
        data.top_rated_books?.forEach(book => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-200 hover:bg-gray-100 transition duration-200';
            tr.innerHTML = `
                <td class="py-3 px-6 text-left">
                    <a href="/book/${book._id}" class="text-indigo-600 hover:underline">${book.book_name}</a>
                </td>
                <td class="py-3 px-6 text-left">
                    <a href="/author/${book.author_id}" class="text-indigo-600 hover:underline">${book.author_name}</a>
                </td>
                <td class="py-3 px-6 text-left">${book.average_score}</td>
                <td class="py-3 px-6 text-left">
                    <a href="/review/${book.highest_rated_review._id}" class="text-indigo-600 hover:underline">${book.highest_rated_review.review}</a>
                </td>
                <td class="py-3 px-6 text-left">
                    <a href="/review/${book.lowest_rated_review._id}" class="text-indigo-600 hover:underline">${book.lowest_rated_review.review}</a>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function fetchTopSellingBooks(page = 1) {
        const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
        const params = new URLSearchParams({
            page: page,
            name_filter: nameFilter
        });

        const response = await fetch(`/top-books/top-selling/?${params.toString()}`);
        const data = await response.json();
        const tbody = document.getElementById('topSellingBooks');
        tbody.innerHTML = '';
        data.top_selling_books.forEach(book => {
            const tr = document.createElement('tr');
            tr.className = 'border-b border-gray-200 hover:bg-gray-100 transition duration-200';
            tr.innerHTML = `
                <td class="py-3 px-6 text-left">
                    <a href="/book/${book._id}" class="text-indigo-600 hover:underline">${book.book_name}</a>
                </td>
                <td class="py-3 px-6 text-left">
                    <a href="/author/${book.author_id}" class="text-indigo-600 hover:underline">${book.author_name}</a>
                </td>
                <td class="py-3 px-6 text-left">${book.total_sales}</td>
                <td class="py-3 px-6 text-left">${book.author_total_sales}</td>
                <td class="py-3 px-6 text-left">${book.top_5_publication_year}</td>
                <td class="py-3 px-6 text-left text-lg flex space-x-2">
                    <a href="/sale/${book._id}" class="text-blue-500 hover:text-blue-600 transition duration-300 p-2 border border-blue-500 rounded-lg hover:bg-blue-100"><i class="fas fa-eye"></i></a>
                    <a href="/sale/${book._id}/edit" class="text-yellow-500 hover:text-yellow-600 transition duration-300 p-2 border border-yellow-500 rounded-lg hover:bg-yellow-100"><i class="fas fa-edit"></i></a>
                    <a href="/sale/${book._id}/delete" class="text-red-500 hover:text-red-600 transition duration-300 p-2 border border-red-500 rounded-lg hover:bg-red-100"><i class="fas fa-trash-alt"></i></a>
                </td>
            `;
            tbody.appendChild(tr);
        });

        const pagination = document.getElementById('topSellingPagination');
        pagination.innerHTML = '';
        for (let i = 1; i <= data.num_pages; i++) {
            const button = document.createElement('button');
            button.className = `px-4 py-2 mx-1 rounded ${i == data.current_page ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-indigo-600 hover:bg-indigo-600 hover:text-white transition duration-300'}`;
            button.innerText = i;
            button.onclick = () => fetchTopSellingBooks(i);
            pagination.appendChild(button);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchTopRatedBooks();
    });
</script>
{% endblock %}
